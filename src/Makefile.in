# -----------------------------------------------------------------------------
#
# (c) 2011 Tsitsimpis Ilias
#
# This file is part of the GAC build system.
#
# To understand how the build system works and how to modify it, see HACKING
#
# -----------------------------------------------------------------------------

GHC = @GHC@
BUILDDIR = ../dist
PREFIX = @prefix@
HAPPY  = @HappyCmd@
ALEX   = @AlexCmd@
LFLAGS = @LFLAGS@
YFLAGS = @YFLAGS@

.PHONY: all
all: build

.PHONY: build
build: config Setup
	./Setup build --builddir=$(BUILDDIR)

Setup: Setup.hs
	$(GHC) -o Setup Setup.hs

.PHONY: config
config: $(BUILDDIR)/setup-config

$(BUILDDIR)/setup-config: Setup
	./Setup configure --builddir=$(BUILDDIR) --prefix=$(PREFIX) \
		--with-ghc="$(GHC)" --with-alex="$(ALEX)" --with-happy="$(HAPPY)" \
		--alex-options="$(LFLAGS)" --happy-options="$(YFLAGS)" --user

.PHONY: clean, clean-force
clean:
	@test -e Setup && $(MAKE) clean-force || echo "Nothing to clean here.."
# We use clean-force only if Setup exists
clean-force: Setup
	./Setup clean --builddir=$(BUILDDIR)
	$(RM) Setup.hi Setup.o Setup


.PHONY: install
install: build Setup
	./Setup install --builddir=$(BUILDDIR)
