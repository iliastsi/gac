# -----------------------------------------------------------------------------
#
# (c) 2011 Tsitsimpis Ilias
#
# This file is part of the GAC build system.
#
# To understand how the build system works and how to modify it, see HACKING
#
# -----------------------------------------------------------------------------

prefix      = @prefix@
exec_prefix = @exec_prefix@
builddir    = @abs_top_builddir@/dist
bindir      = @bindir@
datarootdir = @datarootdir@
docdir      = @docdir@
libdir      = @libdir@/${PACKAGE_TARNAME}
mandir      = @mandir@

TAR          = @TarCmd@
INSTALL      = @INSTALL@
INSTALL_PROG = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@

PACKAGE_VERSION = @PACKAGE_VERSION@
PACKAGE_TARNAME = @PACKAGE_TARNAME@
ARCHIVE = $(PACKAGE_TARNAME)-$(PACKAGE_VERSION)

.PHONY: all
all:
	$(MAKE) -C src $@

.PHONY: install
install: all
	@echo "#!/bin/sh"                                        >  gac_shell
	@echo "exedir=\"$(libdir)/lib\""                         >> gac_shell
	@echo "executablename=\"$$""exedir/$(PACKAGE_TARNAME)\"" >> gac_shell
	@echo "topdir=\"$(libdir)\""                             >> gac_shell
	@echo "exec \"$$""executablename\" -B\"$$""topdir\" $$""{1+\"$$""@\"}" >> gac_shell
	$(INSTALL_PROG) -D gac_shell $(bindir)/$(PACKAGE_TARNAME)
	$(RM) gac_shell
	$(INSTALL_PROG) -D $(builddir)/build/$(PACKAGE_TARNAME)/$(PACKAGE_TARNAME) \
			$(libdir)/lib/$(PACKAGE_TARNAME)
	$(INSTALL_DATA) -D LICENSE $(docdir)/LICENSE
	$(INSTALL_DATA) -D README  $(docdir)/README
	$(INSTALL_DATA) -D docs/alan2011.pdf $(docdir)/alan2011.pdf
	$(INSTALL_DATA) -D docs/man_page/gac.1.gz $(mandir)/man1/$(PACKAGE_TARNAME).1.gz

.PHONY: uninstall
uninstall:
	$(RM) $(bindir)/$(PACKAGE_TARNAME)
	$(RM) -r $(libdir)
	$(RM) -r $(docdir)
	$(RM) $(mandir)/man1/$(PACKAGE_TARNAME).1.gz

.PHONY: dist
dist:
	@echo "Cleaning all the generated files.."
	$(MAKE) maintainer-clean
	$(RM) -r $(ARCHIVE)
	$(RM) $(ARCHIVE).tar.gz
	@echo "Copying files.."
	mkdir $(ARCHIVE)
	$(TAR) cf - --exclude=$(ARCHIVE) --exclude-vcs * | \
		(cd $(ARCHIVE) && tar xf -)
	@echo "Generating archive.."
	$(TAR) zcf $(ARCHIVE).tar.gz $(ARCHIVE)
	@echo "Cleaning temp files.."
	$(RM) -r $(ARCHIVE)

.PHONY: distcheck
distcheck: dist
	@echo "Unpacking the tar.."
	tar xzf $(ARCHIVE).tar.gz
	@echo "Configuring the dist package.."
	(cd $(ARCHIVE) && ./configure)
	@echo "Compiling the dist package.."
	$(MAKE) -C $(ARCHIVE)
	@echo "Testing the dist package.."
	$(MAKE) -C $(ARCHIVE) test
	@echo "Cleaning temp files.."
	$(RM) -r $(ARCHIVE)

.PHONY: clean
clean:
	$(MAKE) -C src $@

.PHONY: distclean
distclean: clean
	$(RM) Makefile src/Makefile src/config.h src/gac.cabal src/versions.h
	$(RM) config.log config.status

.PHONY: maintainer-clean
maintainer-clean: distclean
	$(RM) -r autom4te.cache

.PHONY: test
test:
	@echo "Coming soon.."
